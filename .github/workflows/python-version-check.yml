name: Python Version Check

on:
  schedule:
    # Run monthly on the 1st at 9am ET (check for new Python releases)
    - cron: '0 14 1 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-python-versions:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for new Python versions
        id: check
        run: |
          # Get currently supported versions from test matrix
          CURRENT_VERSIONS=$(grep -A 1 'python-version:' .github/workflows/test.yml | grep -oE '"[0-9]+\.[0-9]+"' | tr -d '"' | sort -V | tail -1)
          echo "current_max=$CURRENT_VERSIONS" >> $GITHUB_OUTPUT

          # Get latest Python version from actions/python-versions
          LATEST=$(gh api repos/actions/python-versions/releases --jq '[.[] | select(.tag_name | test("^[0-9]+\\.[0-9]+\\.0-[0-9]+$"))] | .[0].tag_name' | grep -oE '^[0-9]+\.[0-9]+')
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          # Compare versions
          if [ "$CURRENT_VERSIONS" != "$LATEST" ]; then
            echo "new_version=true" >> $GITHUB_OUTPUT
            echo "New Python version available: $LATEST (current max: $CURRENT_VERSIONS)"
          else
            echo "new_version=false" >> $GITHUB_OUTPUT
            echo "Python versions up to date (latest: $LATEST)"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create issue for new Python version
        if: steps.check.outputs.new_version == 'true'
        run: |
          CURRENT_MAX="${{ steps.check.outputs.current_max }}"
          LATEST="${{ steps.check.outputs.latest }}"

          # Check if issue already exists
          EXISTING=$(gh issue list --label python-version --state open --json title --jq ".[] | select(.title | contains(\"Python $LATEST\")) | .title")

          if [ -z "$EXISTING" ]; then
            # Create issue body in heredoc
            BODY=$(cat <<EOF
          ## New Python Version Available

          Python **$LATEST** has been released and is available in GitHub Actions.

          Current maximum supported version: **$CURRENT_MAX**

          ## Required Changes

          To add full Python $LATEST support, update the following:

          ### 1. ✅ Dependency Constraint
          Renovate will create a PR for this automatically.

          ### 2. ❌ PyPI Classifier (Manual)
          \`\`\`toml
          # pyproject.toml - ADD to classifiers list:
          "Programming Language :: Python :: $LATEST",
          \`\`\`

          **File:** \`pyproject.toml\` around line 43

          ### 3. ❌ CI Test Matrix (Manual)
          \`\`\`yaml
          # .github/workflows/test.yml - ADD to matrix:
          python-version: [..., "$LATEST"]
          \`\`\`

          **File:** \`.github/workflows/test.yml\` line 14

          ### 4. ❌ Codecov Upload Version (Manual)
          \`\`\`yaml
          # .github/workflows/test.yml - UPDATE:
          if: matrix.python-version == '$LATEST'  # was '$CURRENT_MAX'
          \`\`\`

          **File:** \`.github/workflows/test.yml\` line 36

          ### 5. Optional: Quality Workflow
          \`\`\`yaml
          # .github/workflows/quality.yml - UPDATE (optional):
          python-version: "$LATEST"
          \`\`\`

          **File:** \`.github/workflows/quality.yml\` line 19

          ## Checklist

          - [ ] Wait for or manually trigger Renovate PR for Python version
          - [ ] Add classifier to pyproject.toml
          - [ ] Add $LATEST to test matrix
          - [ ] Update Codecov condition to $LATEST
          - [ ] (Optional) Update quality workflow to $LATEST
          - [ ] Verify CI passes on all versions
          - [ ] Merge PR

          ## Notes

          - Renovate will likely create a PR within a week (scheduled Mondays)
          - You can manually add the additional changes to Renovate's PR
          - Or create a separate PR after Renovate's PR is merged

          ---
          *This issue was automatically created by the Python Version Check workflow.*
          EOF
          )

            gh issue create \
              --title "Add Python $LATEST support" \
              --label "python-version,enhancement,dependencies" \
              --body "$BODY"
            echo "Created issue for Python $LATEST support"
          else
            echo "Issue already exists for Python $LATEST"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
